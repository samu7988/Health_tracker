/********************************************************************
 * @file Accelerometer.c
 * @brief 1)setup accelerometer, enable free fall detection
 * @Description : Enable accelerometer for i2c mode of operation and enable free fall detection
 *
 * SDA : PC10
 * SCL : PC11
 * INT1: PC8
 * @author Sayali Mule
 * @date  November 17, 2021
 * @Reference:
 **********************************************************************/

//***********************************************************************************
//                              Include files
//***********************************************************************************
#include "i2c.h"
#include "accelerometer.h"
// Include logging for this file
#define INCLUDE_LOG_DEBUG 1
#include "src/log.h"
//***********************************************************************************
//                              Global variable
//***********************************************************************************


 //***********************************************************************************
 //                              Macros
 //***********************************************************************************


uint8_t read_accelerometer_register(uint8_t reg_address)
{

  uint8_t read_data = 0;
  I2C_write(&reg_address, 1, ACCELEROMETER_SENSOR_ADDRESS); //send register address first

  I2C_read(&read_data,1, ACCELEROMETER_SENSOR_ADDRESS); //Read the value

  return read_data;
}

void write_accelerometer_register(uint8_t reg_address, uint8_t write_val)
{


  uint8_t val[2] = {reg_address, write_val};

  I2C_write(&val[0], 2, ACCELEROMETER_SENSOR_ADDRESS); //send the register address first


}

 /*------------------------------------------------------------------------------------------------------------------------------------*/
 /*
 @brief:Setup accelerometer
 @param: none
 @return: none
 */
 /*-----------------------------------------------------------------------------------------------------------------------------*/
void setup_accelerometer()
{
  /*GPIO pin setup.
    SDA : PC10
    SCL : PC11
    INT1: PC8
  */

  uint8_t val = 0;

  //Read the Device ID register
  val = read_accelerometer_register(ACCEL_DEVID);

  //Enable measurement mode
  write_accelerometer_register(ACCEL_REG_POWER_CTL, MEASUREMENT_MODE);

  // Clear settings
  clear_settings();

  LOG_INFO("Val %x\n\r",val);
//  if (!accelerometer_init()) {
//      LOG_INFO("Accelerometer initialisation failed\n\r");
//  }
//  else
//  {
//      LOG_INFO("Accelerometer initilisation passed\n\r");
//  }
}


//*****************************************************************************
/*
@brief:Set data range
@param: range: data range
@return: none
*/
//
//****************************************************************************/
static void set_range(accel_range_t range)
{
    // Get actual value register
    uint8_t value = read_accelerometer_register(ACCEL_REG_DATA_FORMAT);

    // Update the data rate
    // (&) 0b11110000 (0xF0 - Leave HSB)
    // (|) 0b0000xx?? (range - Set range)
    // (|) 0b00001000 (0x08 - Set Full Res)
    value &= 0xF0;
    value |= range;
    value |= 0x08;

    write_accelerometer_register(ADXL345_REG_DATA_FORMAT, value);
}
/*------------------------------------------------------------------------------------------------------------------------------------*/
/*
@brief: accelerometer initialisation
@param: none
@return: none
*/
/*-----------------------------------------------------------------------------------------------------------------------------*/
void accelerometer_init()
{

}
